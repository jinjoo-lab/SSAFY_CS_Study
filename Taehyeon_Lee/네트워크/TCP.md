# TCP

## TCP란?

> **`TCP(Transmission Control Protocol)`**는 OSI 7계층 중 전송 계층에서 사용되고 있는 프로토콜로, 장비들 간의 통신 과정에서 정보를 안정적으로, 순서대로, 에러없이 교환할 수 있도록 하는 것에 목적을 둔 프로토콜
> 

전송 제어 프로토콜(Transmission Control Protocol)은 인터넷 프로토콜 스위트(IP)의 핵심 프로토콜 중 하나이다

TCP는 근거리 통신망이나 인트라넷, 인터넷에 연결된 컴퓨터에서 실행되는 프로그램간의 일련의 옥텟을 안정적으로, 순서대로, 에러없이 교환할 수 있게 한다.

- 옥텟이란
    - 옥텟(Octet)이란, 바이트와 동일한 의미로 사용되는 말로, 8비트를 의미하며, 데이터패킷을 구성하는 기본 단위를 가리킨다
    - 옥텟이란 용어가 생긴 이유: 과거에는 1바이트가 반드시 8비트라는 개념이 존재하지 않았다 → 4비트, 7비트등 다양했다
    - 1바이트가 8비트를 의미한다는 것을 정확히 지칭하는 단어가 없었기에, 옥텟이라는 단위가 생성되었다
    

TCP는 OSI 7계층에서 4계층(전송계층)에 해당한다.

IP는 패킷들의 관계를 이해하지 못하고, 그저 목적지만 제대로 찾아가는 것에 중점을 두는 반면, TCP는 통신하고자 하는 양쪽 단말이 

- 통신할 준비가 되었는지
- 데이터가 제대로 전송 되었는지
- 데이터가 전송되는 도중 변질되지 않았는지
- 수신자가 얼마나 받았고 빠진부분은 없는지

점검하게된다.

이러한 정보는 TCP Header에 담겨있다

## TCP의 특징

- 연결지향 방식으로 패킷 교환 방식을 사용한다(가상 회선 방식이 아님
- 3-wayhandshaking과정을 통해 연결을 설정하고 4-way handshacking을 통해 해제한다
- 흐름 제어 및 혼잡 제어
- 높은 신뢰성을 보장한다
- udp보다 속도가 느리다
- 전이중(Full-Duplex), 점대점(point-to-point)방식

### TCP 서버의 특징

- 서버소켓은 연결만을 담당한다
- 연결과정에서 반환된 클라이언트 소켓은 데이터의 송수신에 사용된다
- 서버와 클라이언트는 1대1로 연결된다
- 스트림 전송으로 전송데이터의 크기가 무제한이다
- 패킷에 대한 응답을 해야하기 때문에 (시간지연, cpu소모)성능이 낮다
- Streaming 서비스에 불리하다(데이터가 전송 중간에 손실된 경우, 재전송을 요청하기 때문)

## TCP Header

TCP는 전송의 신뢰성과 흐름제어, 혼잡제어 등의 역할을 맡고 있는 프로토콜로, TCP헤더에도 이러한 기능을 사용하기위한 여러 값이 담겨있다

TCP 헤더는 20bytes(160bits)로 이루어져 있으며, 각 필드를 0과 1로 나타내여 전송하고자하는 세그먼트의 정보를 나타낸다

20bytes라는 값은 아무 옵션이 없는 기본 헤더의 용량을 나타내며, 여러가지 옵션이 추가될 경우, 최대 40bytes까지 사용될 수 있다

![Untitled](TCP%20c47a503dc8d74746bc126eaf8558d916/Untitled.png)

### Source port, Destination port

- 각각 16bits
- 이 필드는 세그먼트의 출발지와 목적지를 나타내는 필드이다.
- 출발지와 목적지의 주소를 판단하기 위해서는 IP주소, 포트번호가 필요하다
- IP주소는 한 계층 밑인 네트워크 계층의 IP헤더가 담고 있으며,
- TCP헤더는 포트 번호를 나타내는 필드만 존재한다

### Sequence Number

- 32bits
- 데이터를 전송하는 데이터의 순서를 의미한다
- 최대 4,294,967,296까지의 수를 담을 수 있다.
- 이 시퀀스 번호를 이용하여, 수신자는 쪼개진 세그먼트의 순서를 파악하여, 데이터를 재조립할 수 있다
- 송신자가 최초 데이터 전송시, 이 번호를 랜덤한 수로 초기화 → 자신이 보낼 데이터의 1 bytes당 시퀀스 번호 1씩 증가하여 데이터 순서 표현
- 4,294,967,296를 초과하는 경우 0부터 다시 시작한다

### Acknowledge Number

- 승인번호
- 데이터를 받은 수신자가 예상하는 다음 시퀀스 번호를 의미한다
- 핸드쉐이크 과정 : 상대방이 보낸 `시퀀스번호+1`로 자신의 승인번호 생성
- 실제 데이터를 주고받을 때 : `(상대방이 보낸 시퀀스 번호 + 자신이 받은 데이터의 bytes)` 로 승인 번호를 생성

### Data Offset

- 4bits
- 전체 세그먼트 중에서 헤더가 아닌 데이터가 시작되는 위치가 어디서부터인지 표시한다
- 이 오프셋을 표기할 때 `32비트 워드` 단위를 사용, 32비트 체계에서 `1 word = 4bytes`
- 이 필드에 4를 곱하면 세그먼트에서 헤더를 제외한 실제 데이터의 시작 위치를 알 수 있다
- 4bits로 표현 가능한  0000~1111 범위에서 0~15word 이므로 4를 곱한 0~60bytes의 오프셋까지 표현 가능
- 주의 : 옵션 필드를 제외한 나머지 필드는 필수로 존재해야하기에, 최소 값은 20bytes, 5 word로 제한된다
- 이 필드의 존재 이유 : 옵션(option)필드의 길이가 고정되있지 않기 떄문이다

### Reversed

- 3bits
- 미래를 위해 예약된 필드
- 모두 0으로 채워져야한다
- `0 0 0`

### Flags(NS~FIN)

- 9bits
- 9개의 비트 플래그, 현재 세그먼트의 속성을 나타냄
- 기존의 6개의 플래그에서 혼잡제어 기능 향상을 위해 NS, CWR, ECE플래그가 추가되었다
- 기존 6개 플래그 : URG, ACK, PSH, RST, SYN, FIN
- 추가된 3개 플래그 : NS, CWR, ECE
- 추가된 플래그는 네트워크의 명시적 혼잡통보를 위한 플래그이다

### Window Size

- 16bits
- 한번에 전송할 수 있는 데이터의 양을 의미한다
- 윈도우의 최대 크기는 $2^{16}$만큼의 값으로 64KB이다
- 현재에는 비트를 왼쪽으로 시프트 하는 방식으로 윈도우 사이즈의 최대사이즈를 크게 키우는 방식도 사용하고 있다
    - 옵션 필드의 WSCALE 필드를 사용하여 표기

### Checksum

- 16bits
- 데이터를 송신하는 중에 발생할 수 있는 오류를 검출하기 위한 값이다
- 송신 측
    - 전송할 데이터를 16bits 씩 나눠서 차례대로 더해가는 방법으로 생성한다.
    - 데이터를 16bits씩 add연산을 하며, 만약 비트가 17비트가 되는 경우, 16bits 결과에
    - 1을 더하는 방식으로 계산한다(Warp Around 방식)
    - 최종적으로 나온 결과값에 1의 보수를 취한 값이 전송되는 체크섬비트이다
- 수신측
    - 전달 받은 데이터로 동일하게 add계산을 한후 1의 보수를 취하기 전까지만 만든다
    - 송신측에서 보낸 체크섬과 더해서 모든 비트가 1인경우, 데이터가 정상이라고 판단한다

### Urgent Pointer

- 16bits
- 긴급 포인터
- URG 플래그가 1이면, 수신측에서는 urgent pointer가 가리키고있는 데이터를 우선 처리한다

### Option

- 크기가 고정되지 않고 가변적이다
- TCP의 기능을 확장할 때 사용
- 크기가 가변적이기에 헤더와 데이터의 경계를 계산하기 위해, 오프셋 필드를 사용한다